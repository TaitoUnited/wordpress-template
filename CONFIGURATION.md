# Configuration

> TIP: To save some time, start application in a cleaned and initialized local environment by running: `cd server-template` and `taito kaboom`. Once the command starts to install libraries, leave it on the background, and continue with configuration.

This file has been copied from [WORDPRESS-TEMPLATE](https://github.com/TaitoUnited/WORDPRESS-TEMPLATE/). Keep modifications minimal and improve the [original](https://github.com/TaitoUnited/WORDPRESS-TEMPLATE/blob/dev/CONFIGURATION.md) instead. Note that Taito CLI is optional (see [TAITOLESS.md](TAITOLESS.md)).

## Prerequisites

* [node.js](https://nodejs.org/)
* [docker-compose](https://docs.docker.com/compose/install/)
* [Taito CLI](https://github.com/TaitoUnited/taito-cli#readme) (or see [TAITOLESS.md](TAITOLESS.md))

## Version control settings

Run `taito open conventions` in the project directory to see organization specific settings that you should configure for your git repository.

* [ ] All done

## Basic settings

1. Modify `taito-config.sh` if you need to change some settings. The default settings are ok for most projects.
2. Run `taito project apply`
3. Commit and push changes

* [ ] All done

## Local environment

See the [DEVELOPMENT.md#local-development](DEVELOPMENT.md#local-development) for configuration instructions. If you are using a local database for development, remember to export it to git once in while with `taito db dump initdata`.

* [ ] All done

## Server environments

> Operations on production and staging environments require admin rights, if they contain confidential data. Please contact devops personnel.

### Creating a new server environment

* *Mandatory only for production: Configure DNS record.*
* *Mandatory only for production: Configure app url in `taito-config.sh`*
* *Mandatory only for production: Configure uptime monitoring and alerts*
* Run `taito env apply:ENV` to create an environment. The following server environment are recommended: `stag`, `prod`. TIP: If you use a storage bucket or other external resources in your WordPress setup, but you do not need a separate `dev` remote environment, you can create `dev` environment resources by running `taito env apply:dev terraform` and use those resources in local development.
* At some point you will be asked to create basic auth credentials. The basic auth credentials are used only for hiding non-production environments, but since WordPress has security issues and WordPress might be out on the open until it has been installed properly, it's best to use a strong autogenerated password for each environment. If the git repository is private, you can add the password to the links section of README.md so that all non-developer-collaborators may access it easily. Note that you can show the password on command line at any time with `taito info:ENV` and share it with anyone by running `taito passwd share`.
* Deploy wordpress to the newly created environment by pushing/merging some changes to the environment branch in question.
* Generate a new password for the `changeme` user by using the WordPress admin GUI (`taito open admin:ENV`). The initial admin password is: `password-change-it-7983p4nWgRE2p4No2d9`. If the admin account is shared, save the new password to a secure shared location. Never use the same admin password for every environment, as dev database is committed to git.

* [ ] All done

### Configuring file persistence (for media, etc)

Persistent volume claim (PVC) is disabled by default. This means that all data must be saved either to database or storage bucket. Try to use such wordpress plugins that do not save any permanent data to local disk. If this is not possible, you can enable PVC in `taito-config.sh` with the `wordpress_persistence_enabled` setting and set persistent file paths in `scripts/helm.yaml` with the `persistentVolumeMounts` setting.

If you don't need to manage media files directly on the production website, you can manage media files with your locally running wordpress and save the media files in git. This way the media files will be under version control, and will be bundled inside the Docker container.

You can also store media files to a storage bucket with one of the following wp-plugins. Note that bucket and service account are created automatically by Terraform on `taito env apply:ENV`. You can use dev environment resources also for local development (see [Creating a new server environment](#creating-a-new-server-environment)). You can open the bucket with `taito open storage:ENV` and the service account details with `taito open services:ENV`.
  * [wp-stateless](https://wordpress.org/plugins/wp-stateless/) for Google Cloud. Settings: mode=`Stateless`, bucket=`wordpress-template-ENV`, bucket folder=`/media`, create a JSON key for `wordpress-template-ENV` service account from gcloud console (`taito open services:ENV` -> Credentials -> Create service account key).
  * [https://github.com/humanmade/S3-Uploads](S3-Uploads) for AWS.

Remember to delete all service account keys and other secrets from your local disk.

* [ ] All done

---

## Remote environments

You create the other environments just like the dev environment (see the previous chapter). However, you don't need to write down the basic auth credentials anymore, since you can reuse the same credentials as in dev environment.

Examples for environment names: `f-orders`, `dev`, `test`, `stag`, `canary`, `prod`. You configure project environments with `taito_environments` setting in `taito-config.sh`.

See [6. Remote environments](https://github.com/TaitoUnited/taito-cli/blob/master/docs/tutorial/05-remote-environments.md) chapter of Taito CLI tutorial for more thorough instructions.

Operations on production and staging environments usually require admin rights. Please contact DevOps personnel if necessary.

## Kubernetes

If you need to, you can configure Kubernetes settings by modifying `heml*.yaml` files located under the `scripts`-directory. The default settings, however, are ok for most sites.

## Secrets

You can add a new secret like this:

1. Add a secret definition to the `taito_secrets` setting in `taito-config.sh`.
2. Map the secret definition to a secret in `docker-compose.yaml` for Docker Compose and in `scripts/helm.yaml` for Kubernetes.
3. Run `taito env rotate:ENV SECRET` to generate a secret value for an environment. Run the command for each environment separately. Note that the rotate command restarts all pods in the same namespace.
